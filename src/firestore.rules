
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is the owner of a document.
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Helper function to check if the user is an admin.
    function isAdmin() {
      return request.auth != null && request.auth.token.email == 'abhayrat603@gmail.com';
    }

    // Publicly readable collections, writable only by admin
    match /services/{serviceId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /comboPackages/{comboPackageId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /media/{mediaId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- Rules for the 'orders' collection ---
    
    // Rule for document-level access (/orders/{orderId})
    match /orders/{orderId} {
      // Admins can get any order. Users can get their own order.
      allow get: if isAdmin() || (resource.data.userId != null && isOwner(resource.data.userId));
      
      // Only Admins can update an order's status or details.
      allow update: if isAdmin();
      
      // Deleting orders is not allowed from the client for data integrity.
      allow delete: if false;
    }
    
    // Rule for collection-level queries on 'orders'
    // This MUST be separate from the document-level match.
    match /orders {
        // Only Admins can list all orders. This is the fix for the main error.
        allow list: if isAdmin();
        
        // Authenticated users can create orders for themselves.
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // --- Rules for the 'users' collection and subcollections ---
    match /users/{userId} {
      // A user can read/write their own profile. Admin can too.
      allow get, update, create: if isOwner(userId) || isAdmin();
      
      // Nobody can list all user documents to protect privacy.
      allow list, delete: if false;

      // Notifications subcollection
      match /notifications/{notificationId} {
        // Users can list and read their own notifications.
        allow get, list: if isOwner(userId);
        
        // Only the server/admin can create/update/delete notifications.
        allow create, update, delete: if isAdmin();
      }

      // Downloadable products subcollection
      match /downloadableProducts/{productId} {
        // Users can list and read their own downloadable products.
        allow get, list: if isOwner(userId);

        // Only the server/admin can create/update/delete products.
        allow create, update, delete: if isAdmin();
      }
    }
  }
}
