rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is the owner of a document.
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Helper function to check if the user is an admin.
    function isAdmin() {
      // In a real app, this might check a custom claim: request.auth.token.admin == true
      return request.auth != null && request.auth.token.email == 'abhayrat603@gmail.com';
    }

    // Publicly readable collections
    match /services/{serviceId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /comboPackages/{comboPackageId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /media/{mediaId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- Orders Collection Rules ---
    
    // Rules for individual order documents
    match /orders/{orderId} {
      // Admins can get any order, users can get their own.
      allow get: if isAdmin() || isOwner(resource.data.userId);
      
      // Only Admins can update an order's status or details.
      allow update: if isAdmin();
      
      // Deleting orders is not allowed from the client for data integrity.
      allow delete: if false;
    }

    // Rules for the entire 'orders' collection
    match /orders {
        // Only Admins can list all orders. This is a collection-level query.
        allow list: if isAdmin();
        
        // Authenticated users can create orders for themselves.
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }


    // User-specific private data is nested under the user's ID.
    match /users/{userId} {
      // A user can read and write to their own top-level profile document.
      // Admin can also access any user's profile.
      allow get, update, create: if isOwner(userId) || isAdmin();
      
      // Listing all users is forbidden to protect privacy.
      allow list, delete: if false;

      // Notifications subcollection
      match /notifications/{notificationId} {
        // Users can list and read their own notifications.
        allow get, list: if isOwner(userId);
        
        // Only the server/admin can create/update/delete notifications.
        allow create, update, delete: if isAdmin();
      }

      // Downloadable products subcollection
      match /downloadableProducts/{productId} {
        // Users can list and read their own downloadable products.
        allow get, list: if isOwner(userId);

        // Only the server/admin can create/update/delete products.
        allow create, update, delete: if isAdmin();
      }
    }
  }
}
